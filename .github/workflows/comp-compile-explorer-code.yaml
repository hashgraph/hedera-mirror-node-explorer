name: "ZC: Compile"
on:
  workflow_call:
    inputs:
      enable-unit-tests:
        description: "Unit Testing Enabled:"
        type: boolean
        required: false
        default: false
      enable-e2e-tests:
        description: "E2E Testing Enabled:"
        type: boolean
        required: false
        default: false
      enable-sonar-analysis:
        description: "Sonar Analysis Enabled:"
        type: boolean
        required: false
        default: false
      custom-job-label:
        description: "Custom Job Label:"
        type: string
        required: false
        default: "Compiles"

    secrets:
      access-token:
        description: "The Github access token used to checkout the repository, submodules, and make GitHub API calls."
        required: true
      sonar-token:
        description: "The SonarCloud access token used by the SonarQube agent to report an analysis."
        required: false

defaults:
  run:
    shell: bash

permissions:
  pull-requests: write
  checks: write
  issues: read
  contents: read

env:
  LC_ALL: C.UTF-8

jobs:
  compile:
    name: ${{ inputs.custom-job-label || 'Compiles' }}
    runs-on: [ self-hosted, Linux, large, ephemeral ]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a4aa98b93cab29d9b1101a6143fb8bce00e2eac4 # v2.7.1
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6
        with:
          fetch-depth: 0

      - name: Setup NodeJS
        uses: actions/setup-node@1a4442cacd436585916779262731d5b162bc6ec7 # v3.8.2
        with:
          node-version: 20
          cache: npm

      - name: Setup Xvfb
        if: ${{ inputs.enable-e2e-tests && !cancelled() }}
        run: |
          if ! command -v xvfb-run >/dev/null 2>&1; then
            echo "::group::Updating Aptitude"
              sudo apt update
            echo "::endgroup::"
            echo "::group::Installing Xvfb"
              sudo apt install -y xvfb
            echo "::endgroup::"
          fi

      - name: Install Google Chrome
        if: ${{ inputs.enable-e2e-tests && !cancelled() }}
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          curl -LO https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb

      - name: Install Dependencies
        run: npm ci

      - name: Compile Code
        run: npm run build

      - name: Unit Tests
        run: npm run cover:unit
        if: ${{ inputs.enable-unit-tests && !cancelled() }}

      - name: Report Unit Test Coverage
        uses: davelosert/vitest-coverage-report-action@1c46e624fc42799d6b1090de7decc8b967784fce # v2.3.1
        if: ${{ inputs.enable-unit-tests && !cancelled() }}

      - name: Cypress run
        uses: cypress-io/github-action@248bde77443c376edc45906ede03a1aba9da0462 # v5.8.4
        if: ${{ inputs.enable-e2e-tests && !cancelled() }}
        with:
          install-command: npm install
          browser: chrome
          start: npm run dev
          spec: tests/e2e/specs/*

      - name: Sonar Analysis
        uses: sonarsource/sonarcloud-github-action@49e6cd3b187936a73b8280d59ffd9da69df63ec9 # v2.1.1
        if: ${{ inputs.enable-sonar-analysis && !cancelled() }}
        env:
          GITHUB_TOKEN: ${{ secrets.access-token }}
          SONAR_TOKEN: ${{ secrets.sonar-token }}
